using Application.DTOs.TaskCheckList;
using Infrastructure;
using Microsoft.EntityFrameworkCore;

namespace Application.Services.TaskCheckList
{
    public class TaskCheckListService : ITaskCheckListService
    {
        private readonly AppDbContext _context;
        public TaskCheckListService(AppDbContext context) {
            _context = context;
        }
        public async Task<TaskCheckListDto> CreateTaskCheckList(CreateTaskCheckListDto dto, Guid userId)
        {
            var taskItem = GetTaskItemAsync(dto.TaskItemId, userId);            

            var maxPosition = await _context.TaskCheckList                
                .Where(t => t.TaskItemId == dto.TaskItemId)
                .MaxAsync(t => (int?)t.Position) ?? 0;

            var taskCheckList = new Domain.Entities.TaskCheckList
            {
                Id = Guid.NewGuid(),
                Title = dto.Title,
                TaskItemId = dto.TaskItemId,
                Position = maxPosition + 1
            };

            _context.TaskCheckList.Add(taskCheckList);
            await _context.SaveChangesAsync();

            return new TaskCheckListDto
            {
                Id = taskCheckList.Id,
                Title = taskCheckList.Title,
                TaskItemId = taskCheckList.TaskItemId,
                Position = taskCheckList.Position
            };
        }
        

        public async Task DeleteTaskCheckList(Guid taskCheckListId, Guid userId)
        {
            var taskCheckList = await _context.TaskCheckList
                .Include(t => t.TaskItem)
                .ThenInclude(t => t.Column)
                .ThenInclude(t => t.Board)
                .FirstOrDefaultAsync(t => t.Id == taskCheckListId && t.TaskItem.Column.Board.UserId == userId);
            if (taskCheckList == null) { throw new Exception("Access denied"); }

            _context.TaskCheckList.Remove(taskCheckList);
            await _context.SaveChangesAsync();

            var reoderedTaskCheckLists = await _context.TaskCheckList
                .Where(t => t.TaskItemId == taskCheckList.TaskItemId)
                .OrderBy(t => t.Position)
                .ToListAsync();

            for (int i = 0; i < reoderedTaskCheckLists.Count(); i++)
            {
                reoderedTaskCheckLists[i].Position = i;
            }

            await _context.SaveChangesAsync();
        }

        public async Task<List<TaskCheckListDto>> GetTaskCheckListsAsync(Guid taskItemId, Guid userId)
        {
            var taskItem = GetTaskItemAsync(taskItemId, userId);

            return await _context.TaskCheckList
                .Where(t => t.TaskItemId == taskItemId)
                .OrderBy(t => t.Position)
                .Select(t => new TaskCheckListDto
                {
                    Id = t.Id,
                    Title = t.Title,
                    TaskItemId = taskItemId,
                    Position = t.Position
                })
                .ToListAsync();            
        }

        public async Task UpdateTaskCheckList(Guid taskCheckListId, UpdateTaskCheckListDto dto, Guid userId)
        {
            var taskCheckList = await _context.TaskCheckList
                .Include(t => t.TaskItem)
                .ThenInclude(t => t.Column)
                .ThenInclude(t => t.Board)
                .FirstOrDefaultAsync(t => t.Id == taskCheckListId && t.TaskItem.Column.Board.UserId == userId);
            if (taskCheckList == null) { throw new Exception("Access denied"); }

            taskCheckList.Title = dto.Title;
            await _context.SaveChangesAsync();
        }

        private async Task<Domain.Entities.TaskItem> GetTaskItemAsync(Guid taskItemId, Guid userId)
        {
            var task = await _context.TaskItem
                .Include(c => c.Column)
                .ThenInclude(c => c.Board)
                .FirstOrDefaultAsync(c => c.Id == taskItemId && c.Column.Board.UserId == userId);

            if (task == null) { throw new Exception("Access denied"); }

            return task;
        }
    }
}
